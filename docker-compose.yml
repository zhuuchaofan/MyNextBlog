services:
  # === 数据库服务 (PostgreSQL) ===
  db:
    image: postgres:15-alpine
    container_name: mynextblog-db
    restart: always
    environment:
      POSTGRES_USER: blog_admin
      POSTGRES_PASSWORD: ${DB_PASSWORD}
      POSTGRES_DB: my_blog
      TZ: Asia/Shanghai
    volumes:
      - pg_data:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U blog_admin -d my_blog"]
      interval: 10s
      timeout: 5s
      retries: 5
    ports:
      - "5433:5432"  # 主机5433映射到容器5432，避免与本地PostgreSQL冲突

  # === 后端服务 (.NET API) ===
  backend:
    build: ./backend
    image: mynextblog-backend
    container_name: mynextblog-backend
    restart: always
    ports:
      - "8080:8080"
    depends_on:
      db:
        condition: service_healthy
    environment:
      # 设置时区为上海
      - TZ=Asia/Shanghai
      # 监听 8080 端口
      - ASPNETCORE_URLS=http://+:8080
      # 覆盖连接字符串，指向挂载的 data 目录
      - ConnectionStrings__DefaultConnection=Data Source=/app/data/blog.db

      # === 敏感配置 (从 .env 读取) ===
      # Cloudflare R2
      - CloudflareR2__ServiceUrl=${R2_SERVICE_URL}
      - CloudflareR2__AccessKey=${R2_ACCESS_KEY}
      - CloudflareR2__SecretKey=${R2_SECRET_KEY}
      - CloudflareR2__BucketName=${R2_BUCKET_NAME}
      - CloudflareR2__PublicDomain=${R2_PUBLIC_DOMAIN}
      # JWT
      - JwtSettings__SecretKey=${JWT_SECRET}
      - JwtSettings__Issuer=${JWT_ISSUER}
      - JwtSettings__Audience=${JWT_AUDIENCE}
      # SMTP
      - SmtpSettings__SenderEmail=${SMTP_EMAIL}
      - SmtpSettings__SenderPassword=${SMTP_PASSWORD}
      - SmtpSettings__AdminEmail=${SMTP_EMAIL}
      # App
      - AppUrl=${APP_URL}
    volumes:
      # 挂载数据库文件，保证重启不丢数据 (宿主机 ./data -> 容器 /app/data)
      - ./data:/app/data
      # 挂载上传目录 (同步本地 backend/wwwroot/uploads 与容器内目录)
      - ./backend/wwwroot/uploads:/app/wwwroot/uploads
      # 挂载日志目录 (Serilog)
      - ./logs:/app/logs

    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8080/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s

  # === 前端服务 (Next.js) ===
  frontend:
    build:
      context: ./frontend
      dockerfile: Dockerfile
    image: mynextblog-frontend
    container_name: mynextblog-frontend
    restart: always
    ports:
      # 将宿主机的 3000 端口映射到容器的 3000
      - "3000:3000"
    environment:
      # 设置时区为上海
      - TZ=Asia/Shanghai
      # 告诉 Next.js 后端在 Docker 网络里的名字叫 'backend'，端口是 8080
      - BACKEND_URL=http://backend:8080
      # 注入外部定义的域名 (用于生成 RSS 链接、OpenGraph 等)
      - APP_URL=${APP_URL}
    depends_on:
      backend:
        condition: service_healthy

volumes:
  pg_data:
